<!DOCTYPE html>
<html>
<head>
    <title>CCLLs Sensors Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Load Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <!-- Load Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.4.1/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.4.1/MarkerCluster.Default.css" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat+sans-serif&display=swap" rel="stylesheet">
    <style>
         html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
         body {
            padding-top: 70px;
            font-family: Montserrat, sans-serif;
        }
        .navbar {
            background-color: #003366; /* Dark blue background */
            color: white; /* White text color */
        }
        .navbar-brand img {
            height: 40px; /* Logo height */
            margin-right: 10px; /* Spacing between logo and title */
        }
        .navbar-brand {
            display: flex;
            align-items: center;
            white-space: nowrap;
        }

        /* Additional styles for the title next to the logo */
        .navbar-title {
            color: white; /* Title color */
            font-size: 24px; /* Title font size */
            font-weight: bold; /* Title font weight */
        }
        #map-container, #sidebar-container {
            width: 100%;
            flex: 1;
        }
        #map {
            height: 100%;
        }

        body {
            display: flex;
            flex-direction: column;
        }
        #map-container {
            height: 50%;
        }
        #sidebar-container {
            height: 50%;
            overflow-y: auto;
            padding-left: 10%;
            padding-right: 10%;
        }
         .leaflet-touch .leaflet-control-zoom-display {
        width: 48px;
        height: 48px;
        font-size: 18px;
        line-height: 40px;
    }
    .leaflet-touch .leaflet-bar a, .leaflet-touch .leaflet-toolbar-0 > li > a {
        width: 44px;
        height: 44px;
        font-size: 20px;
        line-height: 45px;
        background-size: 314px 30px;
    }
    .leaflet-touch a {
        background-position-y: 6px;
    }
    .leaflet-touch .leaflet-touch .leaflet-control-toolbar .leaflet-toolbar-1 > li > .leaflet-toolbar-icon {
        font-size: 20px;
        line-height: 44px;
        height: 44px;
    }
    .leaflet-touch .leaflet-touch .leaflet-toolbar-1 {
        left: 45px;
        color: white;
    }
        #loading-gif {
        display: none; /* Hide the loading gif initially */
        margin: 0 auto;
        padding-top: 20%;
        width: 220px;
        height: 220px;
        background: url('https://i.gifer.com/ZZ5H.gif') no-repeat center center; /* Assuming you have a loading.gif in the right path */
    }
    </style>
</head>

<body>
    <!-- Navigation bar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <a class="navbar-brand" href="#">
            <img src="https://score-dt-ewss.test.spatialdynamicslab.xyz/static/images/score_logo_white.png" alt="SCORE Logo">
            CCLLs Sensors Map
        </a>
    </nav>
    <div id="map-container">
        <div id="map"></div>
    </div>
    <br>
    <div id="sidebar-container">
        <img id="loading-gif" alt="Loading..." style="display: none;">
        <div id="device-details">
            <h4>Sensor Details</h4>
            <p>Click on a sensor to see its details and observations.</p>
        </div>
    </div>
    <!-- Load Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Load jQuery and Bootstrap JavaScript -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.4.1/leaflet.markercluster.js"></script>
    <script>

        var smartCitizenMarkers = L.markerClusterGroup();
        var wuMarkers = L.markerClusterGroup();

        // Create a layer control object
        var baseLayers = {

        };

        var overlayLayers = {
            // You can add additional overlay layers here if needed
            "Smart Citizen Devices": smartCitizenMarkers,
             "WU Personal Weather Stations":wuMarkers
        };

        // Create a marker cluster group
        var markers = L.markerClusterGroup({
            spiderfyOnMaxZoom: true, // Spiderfy markers when zoomed in fully
            showCoverageOnHover: false, // Don't show the coverage area when hovering over a cluster
            zoomToBoundsOnClick: true // Zoom to the bounds of the cluster when clicked
        });
        var map = L.map('map').setView([53.3105866, -6.2359141], 13);

        // Load and display tile layer on the map
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CARTO © OpenStreetMap contributors',
            maxZoom: 18
        }).addTo(map);

        L.control.layers(baseLayers, overlayLayers).addTo(map);

        function displayDeviceDetails(feature) {
            properties = feature.properties
            var detailsHtml = '<h4><strong>' + properties.name + '</strong></h4>';
            detailsHtml += '<p>' + properties.description + '</p>';

            // Horizontal table with one row for CCLL Tags, System Tags, and Owner
            detailsHtml += '<table class="table table-sm table-responsive-sm">';
            detailsHtml += '<tr>';
            detailsHtml += '<th>CCLL Tags:</th>';
            detailsHtml += '<td>' + properties.user_tags.join(", ") + '</td>';
            detailsHtml += '<th>System Tags:</th>';
            detailsHtml += '<td>' + properties.system_tags.join(", ") + '</td>';
            detailsHtml += '<th>Owner:</th>';
            detailsHtml += '<td>' + properties.owner + '</td>';
            // detailsHtml += '<th>Time series:</th>';
            // detailsHtml += '<td>' + ' <a href="https://dashboard.smartcitizen.me/?id='
            //     + feature.id + '" class="ml-2" target="_blank">Open</a></td>';
            detailsHtml += '</tr>';
            detailsHtml += '</table>';
            // Observations table without 'Added At' column
            detailsHtml += '<table class="table table-sm table-bordered table-hover table-responsive-md">' +
                '<thead class="thead-light">' +
                '<tr><th>Value</th><th>Unit</th><th>Measurement</th><th>Last Observation' +
                '</th><th>Sensor</th></tr></thead><tbody>';
            properties.observations.forEach(function(obs) {
                detailsHtml += '<tr><td>' + obs.value + '</td><td>' + obs.unit +
                    '</td><td>' + obs.measurement_name + '</td><td>' + obs.recorded_at +
                    '</td><td>' + obs.sensor_name + '</td></tr>';
            });
            detailsHtml += '</tbody></table>';

            $('#device-details').html(detailsHtml);
        }

         function forEachFeature(feature, layer) {
            layer.on('click', function (e) {
                displayDeviceDetails(feature);
            });
        }

        function displayWUDetails(feature) {
            var properties = feature.properties;
            var observations = properties.observations;

            var detailsHtml = '<h4><strong>' + properties.name + '</strong><h6>' + properties.observations.recorded_at + '</h6></h4>';
            // var detailsHtml = '<h6><strong>' + properties.observations.recorded_at + '</strong></h6>';

            // Crear una tabla para mostrar las observaciones de la estación
            detailsHtml += '<table class="table table-sm table-bordered table-hover table-responsive-md">';
            detailsHtml += '<thead class="thead-light">';
            detailsHtml += '<tr><th>Measurement</th><th>Value</th><th>Unit</th></tr></thead><tbody>';

            // Iterar sobre cada observación y añadir a la tabla
            for (var key in observations) {
                if (observations.hasOwnProperty(key) && key !== 'id' && key !== 'recorded_at' && key !== 'station_id' && key !== 'station_name') {
                    detailsHtml += '<tr><td>' + key.replace(/_/g, ' ').toUpperCase() + '</td>';
                    detailsHtml += '<td>' + observations[key].value + '</td>';
                    detailsHtml += '<td>' + observations[key].unit + '</td></tr>';
                }
            }

            detailsHtml += '</tbody></table>';

            // Mostrar los detalles en el elemento del DOM
            $('#device-details').html(detailsHtml);
        }


        function forEachFeatureWU(feature, layer) {
            layer.on('click', function (e) {
                displayWUDetails(feature);
            });
        }


        // Display loading GIF
        document.getElementById('loading-gif').style.display = 'block';

        fetch('https://environmental-data-ie.spatialdynamicslab.xyz/api/v1/' +
            'smart-citizen/latest-observations.geojson?user_tags=SCOREDUBLINCCLL')
            .then(function(response) {
                return response.json();
            })
            .then(function(geojsonFeatureCollection) {
                var smartCitizenMarkers = L.markerClusterGroup(); // Define markers here
                var smartCitizenLayer = L.geoJSON(geojsonFeatureCollection, {
                    onEachFeature: forEachFeature,
                });

                smartCitizenMarkers.addLayer(smartCitizenLayer);
                map.addLayer(smartCitizenMarkers);
                // map.fitBounds(smartCitizenMarkers.getBounds());
                document.getElementById('loading-gif').style.display = 'none';
            })
            .catch(function(error) {
                console.error('Error fetching GeoJSON data:', error);
                // Hide loading GIF
                document.getElementById('loading-gif').style.display = 'none';
            });

        // Fetch Weather Underground GeoJSON data
        fetch('https://environmental-data-ie.spatialdynamicslab.xyz/api/v1/weather-underground/pws/latest-observations.geojson')
            .then(function(response) {
                return response.json();
            })
            .then(function(geojsonFeatureCollection) {
                var wuMarkers = L.markerClusterGroup(); // Define markers here
                var wuPWSLayer = L.geoJSON(geojsonFeatureCollection, {
                    onEachFeature: forEachFeatureWU,
                });
                wuMarkers.addLayer(wuPWSLayer);
                map.addLayer(wuMarkers);
                // Hide loading GIF
                document.getElementById('loading-gif').style.display = 'none';
            })
            .catch(function(error) {
                console.error('Error fetching Weather Underground GeoJSON data:', error);
                // Hide loading GIF
                document.getElementById('loading-gif').style.display = 'none';
            });

        /*fetch('http://localhost:9001/api/v1/' +
            'smart-citizen/latest-observations.geojson?user_tags=SCOREDUBLINCCLL')
            .then(function(response) {
                return response.json();
            })
            .then(function(geojsonFeatureCollection) {
                var smartCitizenLayer = L.geoJSON(geojsonFeatureCollection, {
                    onEachFeature: forEachFeature,
                });

                smartCitizenMarkers.addLayer(smartCitizenLayer);
                map.addLayer(smartCitizenMarkers);
                // map.fitBounds(smartCitizenMarkers.getBounds());
                document.getElementById('loading-gif').style.display = 'none';
            })
            .catch(function(error) {
                console.error('Error fetching GeoJSON data:', error);
                // Hide loading GIF
                document.getElementById('loading-gif').style.display = 'none';
            });

         // Fetch Weather Underground GeoJSON data
        fetch('http://localhost:9001/api/v1/weather-underground/pws/latest-observations.geojson')
            .then(function(response) {
                return response.json();
            })
            .then(function(geojsonFeatureCollection) {
                var wuPWSLayer = L.geoJSON(geojsonFeatureCollection, {
                    onEachFeature: forEachFeature2,
                });
                wuMarkers.addLayer(wuPWSLayer);
                map.addLayer(wuMarkers);
                // Hide loading GIF
                document.getElementById('loading-gif').style.display = 'none';
            })
            .catch(function(error) {
                console.error('Error fetching Weather Underground GeoJSON data:', error);
                // Hide loading GIF
                document.getElementById('loading-gif').style.display = 'none';
            });*/

    </script>
</body>
</html>
