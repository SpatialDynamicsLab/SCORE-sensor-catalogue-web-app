<script>
     // Display loading GIF
    document.getElementById('loading-gif').style.display = 'block';
    var smartCitizenMarkers = L.markerClusterGroup({
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true
    });
    var wuMarkers = L.markerClusterGroup({
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true
    });

    var baseLayers = {};
    var overlayLayers = {
        "Smart Citizen Devices": smartCitizenMarkers,
         "WU Personal Weather Stations":wuMarkers
    };

    var map = L.map('map').setView([53.3105866, -6.2359141], 13);

    // Load and display tile layer on the map
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; CARTO © OpenStreetMap contributors',
        maxZoom: 18
    }).addTo(map);

    // L.control.layers(baseLayers, overlayLayers).addTo(map);

    function displayDeviceDetails(feature) {
        properties = feature.properties
        var detailsHtml = '<h4><strong>' + properties.name + '</strong></h4>';
        detailsHtml += '<p>' + properties.description + '</p>';

        // Horizontal table with one row for CCLL Tags, System Tags, and Owner
        detailsHtml += '<table class="table table-sm table-responsive-sm">';
        detailsHtml += '<tr>';
        detailsHtml += '<th>CCLL Tags:</th>';
        detailsHtml += '<td>' + properties.user_tags.join(", ") + '</td>';
        detailsHtml += '<th>System Tags:</th>';
        detailsHtml += '<td>' + properties.system_tags.join(", ") + '</td>';
        detailsHtml += '<th>Owner:</th>';
        detailsHtml += '<td>' + properties.owner + '</td>';
        // detailsHtml += '<th>Time series:</th>';
        // detailsHtml += '<td>' + ' <a href="https://dashboard.smartcitizen.me/?id='
        //     + feature.id + '" class="ml-2" target="_blank">Open</a></td>';
        detailsHtml += '</tr>';
        detailsHtml += '</table>';
        // Observations table without 'Added At' column
        detailsHtml += '<table class="table table-sm table-bordered table-hover table-responsive-md">' +
            '<thead class="thead-light">' +
            '<tr><th>Value</th><th>Unit</th><th>Measurement</th><th>Last Observation' +
            '</th><th>Sensor</th></tr></thead><tbody>';
        properties.observations.forEach(function(obs) {
            detailsHtml += '<tr><td>' + obs.value + '</td><td>' + obs.unit +
                '</td><td>' + obs.measurement_name + '</td><td>' + obs.recorded_at +
                '</td><td>' + obs.sensor_name + '</td></tr>';
        });
        detailsHtml += '</tbody></table>';

        $('#device-details').html(detailsHtml);
    }

     function forEachFeature(feature, layer) {
        layer.on('click', function (e) {
            displayDeviceDetails(feature);
        });
    }

    function displayWUDetails(feature) {
        var properties = feature.properties;
        var observations = properties.observations;

        var detailsHtml = '<h4><strong>' + properties.name + '</strong><h6>'
            + properties.observations.recorded_at + '</h6></h4>';
        // var detailsHtml = '<h6><strong>' + properties.observations.recorded_at + '</strong></h6>';

        // Crear una tabla para mostrar las observaciones de la estación
        detailsHtml += '<table class="table table-sm table-bordered ' +
            'table-hover table-responsive-md">';
        detailsHtml += '<thead class="thead-light">';
        detailsHtml += '<tr><th>Measurement</th><th>Value</th>' +
            '<th>Unit</th></tr></thead><tbody>';

        // Iterate each observation and add to the table
        for (var key in observations) {
            if (observations.hasOwnProperty(key) && key !== 'id' && key
                !== 'recorded_at' && key !== 'station_id' && key !== 'station_name') {
                detailsHtml += '<tr><td>' + key.replace(/_/g, ' ').toUpperCase() + '</td>';
                detailsHtml += '<td>' + observations[key].value + '</td>';
                detailsHtml += '<td>' + observations[key].unit + '</td></tr>';
            }
        }

        detailsHtml += '</tbody></table>';

        $('#device-details').html(detailsHtml);
    }

    function forEachFeatureWU(feature, layer) {
        layer.on('click', function (e) {
            displayWUDetails(feature);
        });
    }

    fetch('https://environmental-data-ie.spatialdynamicslab.xyz/api/v1/' +
        'smart-citizen/latest-observations.geojson?user_tags=SCOREDUBLINCCLL')
        .then(function(response) {
            return response.json();
        })
        .then(function(geojsonFeatureCollection) {
            var smartCitizenMarkers = L.markerClusterGroup(); // Define markers here
            var smartCitizenLayer = L.geoJSON(geojsonFeatureCollection, {
                onEachFeature: forEachFeature,
            });

            smartCitizenMarkers.addLayer(smartCitizenLayer);
            map.addLayer(smartCitizenMarkers);
            // map.fitBounds(smartCitizenMarkers.getBounds());
            document.getElementById('loading-gif').style.display = 'none';
        })
        .catch(function(error) {
            console.error('Error fetching GeoJSON data:', error);
            // Hide loading GIF
            document.getElementById('loading-gif').style.display = 'none';
        });

    // Fetch Weather Underground GeoJSON data
    fetch('https://environmental-data-ie.spatialdynamicslab.xyz/api/v1/' +
        'weather-underground/pws/latest-observations.geojson')
        .then(function(response) {
            return response.json();
        })
        .then(function(geojsonFeatureCollection) {
            var wuMarkers = L.markerClusterGroup(); // Define markers here
            var wuPWSLayer = L.geoJSON(geojsonFeatureCollection, {
                onEachFeature: forEachFeatureWU,
            });
            wuMarkers.addLayer(wuPWSLayer);
            map.addLayer(wuMarkers);
            // Hide loading GIF
            document.getElementById('loading-gif').style.display = 'none';
        })
        .catch(function(error) {
            console.error('Error fetching Weather Underground GeoJSON data:', error);
            // Hide loading GIF
            document.getElementById('loading-gif').style.display = 'none';
        });
</script>