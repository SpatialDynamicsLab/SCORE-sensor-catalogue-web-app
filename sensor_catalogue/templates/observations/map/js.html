<script>
     // Display loading GIF
    document.getElementById('loading-gif').style.display = 'block';
    var smartCitizenMarkers = L.markerClusterGroup({
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true
    });
    var wuMarkers = L.markerClusterGroup({
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true
    });

    var baseLayers = {};
    var overlayLayers = {
        "Smart Citizen Devices": smartCitizenMarkers,
        "WU Personal Weather Stations":wuMarkers
    };

    var map = L.map('map').setView([53.3105866, -6.2359141], 13);

    // Load and display tile layer on the map
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; CARTO © OpenStreetMap contributors',
        maxZoom: 18
    }).addTo(map);

    // L.control.layers(baseLayers, overlayLayers).addTo(map);

    function displayDeviceDetails(feature) {
        properties = feature.properties
        var detailsHtml = '<h3 style="color:#004680"><b>' + properties.name + '</b></h3>';
        detailsHtml += '<p>' + properties.description + '<br><br><strong>Last Observation: '
            + properties.last_reading_at +
            '</strong><br><small>Platform provider: ' +
           '<a href="'  + properties.platform_provider.url + '" className="ml-2" target="_blank"> ' +
            properties.platform_provider.name + '</a></small></p>'

        // Horizontal table with one row for CCLL Tags, System Tags, and Owner
        detailsHtml += '<table class="table table-sm table-responsive-sm">';
        detailsHtml += '<tr>';
        detailsHtml += '<th>CCLL Tags:</th>';
        detailsHtml += '<td>' + properties.user_tags.join(", ") + '</td>';
        detailsHtml += '<th>System Tags:</th>';
        detailsHtml += '<td>' + properties.system_tags.join(", ") + '</td>';
        detailsHtml += '<th>Owner:</th>';
        detailsHtml += '<td>' + properties.owner + '</td>';
        // detailsHtml += '<th>Time series:</th>';
        // detailsHtml += '<td>' + ' <a href="https://dashboard.smartcitizen.me/?id='
        //     + feature.id + '" class="ml-2" target="_blank">Open</a></td>';
        detailsHtml += '</tr>';
        detailsHtml += '</table>';
        // Observations table without 'Added At' column
        detailsHtml += '<table class="table table-sm table-bordered table-hover table-responsive-md">' +
            '<thead class="thead-light">' +
            '<tr><th>Sensor</th><th>Measurement</th><th>Value</th><th>Unit</th></tr></thead><tbody>';
        properties.observations.forEach(function(obs) {
            detailsHtml += '<tr><td>' + obs.sensor_name + '</td><td>' + obs.measurement_name +
                '</td><td>' + obs.value + '</td><td>' + obs.unit + '</td></tr>';
        });
        detailsHtml += '</tbody></table>';

        $('#device-details').html(detailsHtml);
    }

     function forEachFeature(feature, layer) {
        layer.on('click', function (e) {
            displayDeviceDetails(feature);
        });
    }

    function displayWUDetails(feature) {
        var properties = feature.properties;
        var observations = properties.observations;

        var detailsHtml = '<h3 style="color:#004680"><b> ' + properties.name + '</b></h3>';
        // var detailsHtml = '<h6><strong>' + properties.observations.recorded_at + '</strong></h6>';
        detailsHtml += '<p>Last observation: <b>' + properties.observations.recorded_at + '</b>' +
            '<br><small>Platform provider: ' + '<a href="'  + properties.platform_provider.url +
            '" className="ml-2" target="_blank"> ' + properties.platform_provider.name + '</a></small></p>'

        // Crear una tabla para mostrar las observaciones de la estación
        detailsHtml += '<table class="table table-sm table-bordered ' +
            'table-hover table-responsive-md">';
        detailsHtml += '<thead class="thead-light">';
        detailsHtml += '<tr><th>Measurement</th><th>Value</th>' +
            '<th>Unit</th></tr></thead><tbody>';

        // Iterate each observation and add to the table
        for (var key in observations) {
            if (observations.hasOwnProperty(key) && key !== 'id' && key
                !== 'recorded_at' && key !== 'station_id' && key !== 'station_name') {
                detailsHtml += '<tr><td>' + key.replace(/_/g, ' ').toUpperCase() + '</td>';
                detailsHtml += '<td>' + observations[key].value + '</td>';
                detailsHtml += '<td>' + observations[key].unit + '</td></tr>';
            }
        }

        detailsHtml += '</tbody></table>';

        $('#device-details').html(detailsHtml);
    }

    function forEachFeatureWU(feature, layer) {
        layer.on('click', function (e) {
            displayWUDetails(feature);
        });
    }


    function loadSmartCitizenData() {
        return fetch('https://environmental-data-ie.spatialdynamicslab.xyz/api/v1/' +
        'smart-citizen/latest-observations.geojson?user_tags=SCOREDUBLINCCLL&system_tags=online')
        .then(function(response) {
            return response.json();
        })
        .then(function(geojsonFeatureCollection) {
            var smartCitizenLayer = L.geoJSON(geojsonFeatureCollection, {
                onEachFeature: forEachFeature,
            });

            smartCitizenMarkers.addLayer(smartCitizenLayer);
            map.addLayer(smartCitizenMarkers);
            document.getElementById('loading-gif').style.display = 'none';
        })
        .catch(function(error) {
            console.error('Error fetching GeoJSON data:', error);
            // Hide loading GIF
            document.getElementById('loading-gif').style.display = 'none';
        });
    }

    function loadWUData() {
        return fetch('https://environmental-data-ie.spatialdynamicslab.xyz/api/v1/' +
        'weather-underground/pws/latest-observations.geojson')
        .then(function(response) {
            return response.json();
        })
        .then(function(geojsonFeatureCollection) {
            var wuPWSLayer = L.geoJSON(geojsonFeatureCollection, {
                onEachFeature: forEachFeatureWU,
            });
            wuMarkers.addLayer(wuPWSLayer);
            map.addLayer(wuMarkers);
            // Hide loading GIF
            document.getElementById('loading-gif').style.display = 'none';
        })
        .catch(function(error) {
            console.error('Error fetching Weather Underground GeoJSON data:', error);
            // Hide loading GIF
            document.getElementById('loading-gif').style.display = 'none';
        });
    }

    Promise.all([loadSmartCitizenData(), loadWUData()])
        .then(() => {
            mapBoundsFit(); // Call this function only after both layers are loaded
            document.getElementById('loading-gif').style.display = 'none';
        })
        .catch(error => {
            console.error('Error loading data:', error);
            document.getElementById('loading-gif').style.display = 'none';
        });


   function mapBoundsFit () {
       try {
           var smartCitizenBounds = smartCitizenMarkers.getBounds();
           var wuBounds = wuMarkers.getBounds();

            var combinedBounds = L.latLngBounds([]);

            if (smartCitizenMarkers.getLayers().length > 0) {
                combinedBounds.extend(smartCitizenBounds);
            }
            if (wuMarkers.getLayers().length > 0) {
                combinedBounds.extend(wuBounds);
            }

            console.log("Smart Citizen Bounds:", smartCitizenBounds);
            console.log("WU Bounds:", wuBounds);
            console.log("Combined Bounds:", combinedBounds);

            if (combinedBounds.isValid()) {
                map.fitBounds(combinedBounds);
            } else {
                console.log("Combined bounds are not valid.");
            }
        } catch (error) {
            console.error("Error fitting map bounds:", error);
        }
   }

</script>